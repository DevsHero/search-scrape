name: Registry Sync

on:
  workflow_run:
    workflows:
      - Release
    types:
      - completed

permissions:
  contents: read
  id-token: write

concurrency:
  group: registry-sync-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  sync:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Read version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          version="$(python3 -c 'import tomllib, pathlib; obj=tomllib.loads(pathlib.Path("mcp-server/Cargo.toml").read_text(encoding="utf-8")); v=obj.get("package",{}).get("version",""); assert v; print(v)')"
          tag="v${version}"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

          server_ver="$(python3 -c 'import json, pathlib; obj=json.loads(pathlib.Path("server.json").read_text(encoding="utf-8")); v=obj.get("version",""); assert v; print(v)')"
          if [[ "$server_ver" != "$version" ]]; then
            echo "❌ server.json version mismatch: Cargo.toml=$version server.json=$server_ver" >&2
            exit 1
          fi

      - name: Wait for GitHub Release to exist
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ steps.meta.outputs.tag }}"
          repo="${GITHUB_REPOSITORY}"
          url="https://api.github.com/repos/${repo}/releases/tags/${tag}"
          echo "Waiting for release tag ${tag} (${url})" >&2
          for i in $(seq 1 30); do
            code=$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$url" || true)
            if [[ "$code" == "200" ]]; then
              echo "✅ Release exists for ${tag}" >&2
              exit 0
            fi
            echo "... not ready yet (HTTP $code), retrying (${i}/30)" >&2
            sleep 10
          done
          echo "❌ Timed out waiting for GitHub Release ${tag}." >&2
          exit 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Publish to Smithery Hub
        shell: bash
        env:
          SMITHERY_TOKEN: ${{ secrets.SMITHERY_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${SMITHERY_TOKEN:-}" ]]; then
            echo "❌ Missing secrets.SMITHERY_TOKEN" >&2
            exit 1
          fi
          npx -y smithery publish

      - name: Install mcp-publisher
        shell: bash
        run: |
          set -euo pipefail
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64)  ARCH_SLUG="amd64" ;;
            aarch64) ARCH_SLUG="arm64" ;;
            arm64)   ARCH_SLUG="arm64" ;;
            *)       echo "❌ Unsupported arch: $ARCH" >&2; exit 1 ;;
          esac
          URL="https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_${OS}_${ARCH_SLUG}.tar.gz"
          curl -fsSL "$URL" | tar xz mcp-publisher
          chmod +x ./mcp-publisher

      - name: Validate server.json
        run: ./mcp-publisher validate server.json

      - name: Login with GitHub OIDC
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          set +e
          output="$(./mcp-publisher publish server.json 2>&1)"
          rc=$?
          set -e
          echo "$output"
          if [[ $rc -eq 0 ]]; then
            exit 0
          fi
          if echo "$output" | grep -qiE '(already (published|exists)|duplicate version|cannot publish duplicate version|409|conflict)'; then
            echo "⚠️  Already published — skipping." >&2
            exit 0
          fi
          exit $rc
