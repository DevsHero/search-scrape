name: Release (Cross-Platform Binaries)

permissions:
  contents: write

on:
  push:
    branches:
      - main
      - master

jobs:
  check-trigger:
    name: Check [build] trigger
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if commit message contains [build]
        id: check
        shell: bash
        run: |
          set -euo pipefail
          msg="$(git log -1 --pretty=%B | tr -d '\r')"
          echo "Commit message:" >&2
          echo "$msg" >&2
          if echo "$msg" | grep -q "\[build\]"; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "✅ Release triggered: commit contains [build]" >&2
          else
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            echo "⏭️  Skipping: commit does not contain [build]" >&2
          fi

      - name: Read version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          version="$(
            python3 - <<'PY'
import pathlib
import sys

path = pathlib.Path('mcp-server/Cargo.toml')
data = path.read_bytes()

try:
    import tomllib  # py3.11+
except Exception as e:
    print('tomllib not available:', e, file=sys.stderr)
    sys.exit(1)

obj = tomllib.loads(data.decode('utf-8'))
v = obj.get('package', {}).get('version', '')
if not v:
    print('Failed to read [package].version from mcp-server/Cargo.toml', file=sys.stderr)
    sys.exit(1)
print(v)
PY
          )"
          tag="v${version}"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "✅ version=$version tag=$tag" >&2

  create-release:
    name: Create tag + GitHub Release
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag (if missing) and push
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ needs.check-trigger.outputs.tag }}"

          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          if git rev-parse -q --verify "refs/tags/$tag" >/dev/null; then
            existing_sha="$(git rev-list -n 1 "$tag")"
            if [[ "$existing_sha" != "$GITHUB_SHA" ]]; then
              echo "❌ Tag already exists ($tag) but points to $existing_sha (current commit is $GITHUB_SHA)." >&2
              echo "Bump version in mcp-server/Cargo.toml and server.json, then commit with [build]." >&2
              exit 1
            fi
            echo "✅ Tag already exists and matches current commit: $tag" >&2
          else
            echo "Creating tag $tag at $GITHUB_SHA" >&2
            git tag "$tag" "$GITHUB_SHA"
            git push origin "$tag"
          fi

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-trigger.outputs.tag }}
          name: ${{ needs.check-trigger.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true

  build-and-release:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    needs:
      - check-trigger
      - create-release
    if: needs.check-trigger.outputs.should_build == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            platform: linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            exe_ext: ""
            archive: tar.gz
            build_non_robot: false

          - name: windows-x64
            platform: windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            exe_ext: .exe
            archive: zip
            build_non_robot: true

          - name: macos-x64
            platform: macos-x64
            os: macos-13
            target: x86_64-apple-darwin
            exe_ext: ""
            archive: tar.gz
            build_non_robot: true

          - name: macos-arm64
            platform: macos-arm64
            os: macos-14
            target: aarch64-apple-darwin
            exe_ext: ""
            archive: tar.gz
            build_non_robot: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            mcp-server

      - name: Prepare dist dir
        shell: bash
        run: |
          set -euo pipefail
          dist="dist/${{ matrix.platform }}"
          mkdir -p "$dist"

      - name: Build (release)
        shell: bash
        run: |
          set -euo pipefail
          cd mcp-server
          cargo build --release --locked --target "${{ matrix.target }}" --bin shadowcrawl --bin shadowcrawl-mcp

      - name: Stage artifacts (default)
        shell: bash
        run: |
          set -euo pipefail

          version="${{ needs.check-trigger.outputs.version }}"
          dist="dist/${{ matrix.platform }}"
          base="mcp-server/target/${{ matrix.target }}/release"

          cp "$base/shadowcrawl${{ matrix.exe_ext }}" "$dist/shadowcrawl${{ matrix.exe_ext }}"
          cp "$base/shadowcrawl-mcp${{ matrix.exe_ext }}" "$dist/shadowcrawl-mcp${{ matrix.exe_ext }}"

          # Include metadata files once.
          cp LICENSE "$dist/LICENSE"
          cp README.md "$dist/README.md"
          cp server.json "$dist/server.json"
          echo "$version" > "$dist/VERSION"

      - name: Build (release, non_robot_search)
        if: matrix.build_non_robot
        shell: bash
        run: |
          set -euo pipefail
          cd mcp-server
          cargo build --release --locked --target "${{ matrix.target }}" --features non_robot_search --bin shadowcrawl --bin shadowcrawl-mcp

      - name: Stage artifacts (non_robot_search)
        if: matrix.build_non_robot
        shell: bash
        run: |
          set -euo pipefail
          dist="dist/${{ matrix.platform }}"
          base="mcp-server/target/${{ matrix.target }}/release"

          cp "$base/shadowcrawl${{ matrix.exe_ext }}" "$dist/shadowcrawl-non_robot_search${{ matrix.exe_ext }}"
          cp "$base/shadowcrawl-mcp${{ matrix.exe_ext }}" "$dist/shadowcrawl-mcp-non_robot_search${{ matrix.exe_ext }}"

      - name: Archive (tar.gz)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          set -euo pipefail
          version="${{ needs.check-trigger.outputs.version }}"
          cd "dist/${{ matrix.platform }}"
          tar -czf "../shadowcrawl-${version}-${{ matrix.platform }}.tar.gz" .

      - name: Archive (zip)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          $version = "${{ needs.check-trigger.outputs.version }}"
          $src = "dist/${{ matrix.platform }}"
          $dst = "dist/shadowcrawl-$version-${{ matrix.platform }}.zip"
          if (Test-Path $dst) { Remove-Item -Force $dst }
          Compress-Archive -Path "$src/*" -DestinationPath $dst

      - name: Upload build artifact (CI)
        uses: actions/upload-artifact@v4
        with:
          name: shadowcrawl-${{ matrix.platform }}
          path: |
            dist/shadowcrawl-*.${{ matrix.archive }}
          if-no-files-found: error

      - name: Attach assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-trigger.outputs.tag }}
          files: |
            dist/shadowcrawl-*-${{ matrix.platform }}.${{ matrix.archive }}
          generate_release_notes: false
