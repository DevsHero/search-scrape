name: Release

on:
  push:
    tags:
      - v*

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    name: Gatekeeper (tests)
    runs-on: ubuntu-latest
    env:
      OPENSSL_STATIC: "1"
      OPENSSL_VENDOR: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Chromium + system libraries
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends ca-certificates curl unzip zip libwayland-dev pkg-config
          if sudo apt-get install -y --no-install-recommends chromium-browser; then
            echo "CHROME_EXECUTABLE=/usr/bin/chromium-browser" >> "$GITHUB_ENV"
          else
            sudo apt-get install -y --no-install-recommends chromium
            echo "CHROME_EXECUTABLE=/usr/bin/chromium" >> "$GITHUB_ENV"
          fi

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            mcp-server

      - name: cargo test (all features)
        shell: bash
        run: |
          set -euo pipefail
          cd mcp-server
          cargo test --all-features --locked -- --nocapture

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard tag matches versions
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF#refs/tags/}"
          version="$(python3 -c 'import tomllib, pathlib; obj=tomllib.loads(pathlib.Path("mcp-server/Cargo.toml").read_text(encoding="utf-8")); v=obj.get("package",{}).get("version",""); assert v; print(v)')"
          expected="v${version}"
          if [[ "$tag" != "$expected" ]]; then
            echo "❌ Tag/version mismatch: tag=$tag expected=$expected" >&2
            exit 1
          fi
          server_ver="$(python3 -c 'import json, pathlib; obj=json.loads(pathlib.Path("server.json").read_text(encoding="utf-8")); v=obj.get("version",""); assert v; print(v)')"
          if [[ "$server_ver" != "$version" ]]; then
            echo "❌ server.json version mismatch: Cargo.toml=$version server.json=$server_ver" >&2
            exit 1
          fi

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ShadowCrawl release assets.

  build:
    name: Build (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs:
      - test
      - create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x64
            target: x86_64-unknown-linux-gnu
            exe_ext: ""
            archive: tar.gz
            use_zig: false
            windows_gnu: false

          - platform: windows-x64
            target: x86_64-pc-windows-gnu
            exe_ext: .exe
            archive: zip
            use_zig: false
            windows_gnu: true

          - platform: macos-x64
            target: x86_64-apple-darwin
            exe_ext: ""
            archive: tar.gz
            use_zig: true
            windows_gnu: false

          - platform: macos-arm64
            target: aarch64-apple-darwin
            exe_ext: ""
            archive: tar.gz
            use_zig: true
            windows_gnu: false

    env:
      OPENSSL_STATIC: "1"
      OPENSSL_VENDOR: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          version="$(python3 -c 'import tomllib, pathlib; obj=tomllib.loads(pathlib.Path("mcp-server/Cargo.toml").read_text(encoding="utf-8")); v=obj.get("package",{}).get("version",""); assert v; print(v)')"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends ca-certificates curl unzip zip

          if [[ "${{ matrix.windows_gnu }}" == "true" ]]; then
            sudo apt-get install -y --no-install-recommends gcc-mingw-w64-x86-64
            echo "CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc" >> "$GITHUB_ENV"
            echo "AR_x86_64_pc_windows_gnu=x86_64-w64-mingw32-ar" >> "$GITHUB_ENV"
          fi

      - name: Install Zig
        if: ${{ matrix.use_zig }}
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.12.0

      - name: Install cargo-zigbuild
        if: ${{ matrix.use_zig }}
        shell: bash
        run: |
          set -euo pipefail
          cargo install --locked cargo-zigbuild

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            mcp-server

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          cd mcp-server
          if [[ "${{ matrix.use_zig }}" == "true" ]]; then
            cargo zigbuild --release --locked --target "${{ matrix.target }}" --bin shadowcrawl --bin shadowcrawl-mcp
          else
            cargo build --release --locked --target "${{ matrix.target }}" --bin shadowcrawl --bin shadowcrawl-mcp
          fi

      - name: Stage + archive
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.meta.outputs.version }}"
          platform="${{ matrix.platform }}"
          target="${{ matrix.target }}"
          exe_ext="${{ matrix.exe_ext }}"
          dist_dir="dist/${platform}"
          mkdir -p "$dist_dir"

          base="mcp-server/target/${target}/release"
          cp "$base/shadowcrawl${exe_ext}" "$dist_dir/shadowcrawl${exe_ext}"
          cp "$base/shadowcrawl-mcp${exe_ext}" "$dist_dir/shadowcrawl-mcp${exe_ext}"
          cp LICENSE README.md server.json "$dist_dir/"
          echo "$version" > "$dist_dir/VERSION"

          out_base="dist/shadowcrawl-${version}-${platform}"
          if [[ "${{ matrix.archive }}" == "zip" ]]; then
            (cd "$dist_dir" && zip -qr "../$(basename "$out_base").zip" .)
          else
            tar -C "$dist_dir" -czf "${out_base}.tar.gz" .
          fi

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/shadowcrawl-*-${{ matrix.platform }}.${{ matrix.archive }}

