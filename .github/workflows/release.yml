name: Release (Cross-Platform Binaries)

permissions:
  contents: write

on:
  push:
    branches:
      - main
      - master
    tags:
      - v*

jobs:
  check-trigger:
    name: Check [build] trigger
    runs-on: ubuntu-latest
    outputs:
      should_linux_ci: ${{ steps.check.outputs.should_linux_ci }}
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if commit message contains [build]
        id: check
        shell: bash
        run: |
          set -euo pipefail
          # Tag pushes (v*) drive full release builds.
          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "should_linux_ci=false" >> "$GITHUB_OUTPUT"
            echo "✅ Tag push detected (${GITHUB_REF}); running release build" >&2
            exit 0
          fi

          # Branch pushes: run Linux-only CI build only when commit contains [build].
          msg="$(git log -1 --pretty=%B | tr -d '\r')"
          echo "Commit message:" >&2
          echo "$msg" >&2
          if echo "$msg" | grep -q "\[build\]"; then
            echo "should_linux_ci=true" >> "$GITHUB_OUTPUT"
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "✅ Linux CI build triggered: commit contains [build]" >&2
          else
            echo "should_linux_ci=false" >> "$GITHUB_OUTPUT"
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "⏭️  Skipping: commit does not contain [build]" >&2
          fi

      - name: Read version metadata
        id: meta
        shell: bash
        if: ${{ steps.check.outputs.should_linux_ci == 'true' || steps.check.outputs.should_release == 'true' }}
        run: |
          set -euo pipefail

          # ── 1. Read version from Cargo.toml ──────────────────────────────────
          version="$(python3 -c 'import tomllib, pathlib; obj=tomllib.loads(pathlib.Path("mcp-server/Cargo.toml").read_text(encoding="utf-8")); v=obj.get("package",{}).get("version",""); assert v, "Missing [package].version in mcp-server/Cargo.toml"; print(v)')"
          tag="v${version}"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "✅ version=$version tag=$tag" >&2

          # If this is a tag push, enforce tag matches Cargo.toml/server.json version.
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            ref_tag="${GITHUB_REF#refs/tags/}"
            if [[ "$ref_tag" != "$tag" ]]; then
              echo "❌ Tag/version mismatch: pushed tag=$ref_tag but Cargo.toml expects $tag" >&2
              exit 1
            fi
            echo "✅ Tag matches version: $ref_tag" >&2
          fi

          # ── 2. Guard: Cargo.toml version must match server.json version ──────
          server_ver="$(python3 -c 'import json, pathlib; obj=json.loads(pathlib.Path("server.json").read_text(encoding="utf-8")); v=obj.get("version",""); assert v, "Missing version in server.json"; print(v)')"
          if [[ "$version" != "$server_ver" ]]; then
            echo "❌ Version mismatch: Cargo.toml=$version but server.json=$server_ver" >&2
            echo "   Sync them and recommit with [build]." >&2
            exit 1
          fi
          echo "✅ server.json version matches Cargo.toml: $version" >&2

          # ── 3. Guard: server.json must be valid JSON ─────────────────────────
          python3 -c 'import json, pathlib; json.loads(pathlib.Path("server.json").read_text(encoding="utf-8")); print("✅ server.json is valid JSON")'

      - name: Install mcp-publisher (validate only)
        shell: bash
        if: ${{ steps.check.outputs.should_linux_ci == 'true' || steps.check.outputs.should_release == 'true' }}
        run: |
          set -euo pipefail
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64)  ARCH_SLUG="amd64" ;;
            aarch64) ARCH_SLUG="arm64" ;;
            arm64)   ARCH_SLUG="arm64" ;;
            *)       echo "❌ Unsupported arch: $ARCH" >&2; exit 1 ;;
          esac
          URL="https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_${OS}_${ARCH_SLUG}.tar.gz"
          echo "Downloading $URL" >&2
          curl -fsSL "$URL" | tar xz mcp-publisher
          chmod +x ./mcp-publisher

      - name: Validate server.json (MCP Registry schema)
        shell: bash
        if: ${{ steps.check.outputs.should_linux_ci == 'true' || steps.check.outputs.should_release == 'true' }}
        run: ./mcp-publisher validate server.json

      - name: Validate smithery.yaml
        shell: bash
        if: ${{ steps.check.outputs.should_linux_ci == 'true' || steps.check.outputs.should_release == 'true' }}
        run: |
          set -euo pipefail
          python3 -c 'import yaml, pathlib; obj=yaml.safe_load(pathlib.Path("smithery.yaml").read_text(encoding="utf-8")); assert isinstance(obj, dict); sc=obj.get("startCommand"); assert isinstance(sc, dict); assert sc.get("type") == "stdio"; assert "configSchema" in sc; assert "commandFunction" in sc; print("✅ smithery.yaml OK")'

      - name: Validate smithery.config-schema.json
        shell: bash
        if: ${{ steps.check.outputs.should_linux_ci == 'true' || steps.check.outputs.should_release == 'true' }}
        run: |
          set -euo pipefail
          python3 -c 'import json, pathlib; obj=json.loads(pathlib.Path("smithery.config-schema.json").read_text(encoding="utf-8")); assert obj.get("type") == "object"; assert isinstance(obj.get("properties"), dict); print("✅ smithery.config-schema.json OK")'

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: check-trigger
    if: ${{ needs['check-trigger'].outputs.should_release == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs['check-trigger'].outputs.tag }}
          name: ${{ needs['check-trigger'].outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## ShadowCrawl ${{ needs['check-trigger'].outputs.tag }}

            Cross-platform prebuilt binaries attached below.

            | Platform | Default | `non_robot_search` |
            |---|---|---|
            | linux-x64 | ✅ | — |
            | linux-arm64 | ✅ | — |
            | windows-x64 | ✅ | ✅ |
            | windows-arm64 | ✅ | ✅ |

  linux-ci:
    name: linux-ci (ubuntu-only)
    runs-on: ubuntu-latest
    needs: check-trigger
    if: ${{ needs['check-trigger'].outputs.should_linux_ci == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            mcp-server

      - name: Build (release) [linux-x64]
        shell: bash
        run: |
          set -euo pipefail
          cd mcp-server
          cargo build --release --locked --target x86_64-unknown-linux-gnu --bin shadowcrawl --bin shadowcrawl-mcp

      - name: Upload build artifact (CI)
        uses: actions/upload-artifact@v4
        with:
          name: shadowcrawl-linux-x64-ci
          path: |
            mcp-server/target/x86_64-unknown-linux-gnu/release/shadowcrawl
            mcp-server/target/x86_64-unknown-linux-gnu/release/shadowcrawl-mcp

  build-and-release:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    needs:
      - check-trigger
      - create-release
    if: ${{ needs['check-trigger'].outputs.should_release == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            platform: linux-x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            exe_ext: ""
            archive: tar.gz
            build_non_robot: false
            use_zig: false

          - name: linux-arm64
            platform: linux-arm64
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            exe_ext: ""
            archive: tar.gz
            build_non_robot: false
            use_zig: true

          - name: windows-x64
            platform: windows-x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            exe_ext: .exe
            archive: zip
            build_non_robot: true
            use_zig: false

          - name: windows-arm64
            platform: windows-arm64
            os: windows-latest
            target: aarch64-pc-windows-msvc
            exe_ext: .exe
            archive: zip
            build_non_robot: true
            use_zig: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup MSVC (ARM64 cross)
        if: ${{ runner.os == 'Windows' && matrix.target == 'aarch64-pc-windows-msvc' }}
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64_arm64

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Zig (for cross-compilation)
        if: ${{ matrix.use_zig }}
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.12.0

      - name: Install cargo-zigbuild
        if: ${{ matrix.use_zig }}
        shell: bash
        run: |
          set -euo pipefail
          if command -v cargo-zigbuild >/dev/null 2>&1; then
            echo "cargo-zigbuild already installed" >&2
            exit 0
          fi
          cargo install --locked cargo-zigbuild

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            mcp-server

      - name: Prepare dist dir
        shell: bash
        run: |
          set -euo pipefail
          dist="dist/${{ matrix.platform }}"
          mkdir -p "$dist"

      - name: Build (release)
        if: ${{ !matrix.use_zig }}
        shell: bash
        run: |
          set -euo pipefail
          cd mcp-server
          cargo build --release --locked --target "${{ matrix.target }}" --bin shadowcrawl --bin shadowcrawl-mcp

      - name: Build (release, zigbuild)
        if: ${{ matrix.use_zig }}
        shell: bash
        env:
          OPENSSL_STATIC: "1"
          OPENSSL_VENDOR: "1"
        run: |
          set -euo pipefail
          cd mcp-server
          cargo zigbuild --release --locked --target "${{ matrix.target }}" --bin shadowcrawl --bin shadowcrawl-mcp

      - name: Stage artifacts (default)
        shell: bash
        run: |
          set -euo pipefail

          version="${{ needs['check-trigger'].outputs.version }}"
          dist="dist/${{ matrix.platform }}"
          base="mcp-server/target/${{ matrix.target }}/release"

          cp "$base/shadowcrawl${{ matrix.exe_ext }}" "$dist/shadowcrawl${{ matrix.exe_ext }}"
          cp "$base/shadowcrawl-mcp${{ matrix.exe_ext }}" "$dist/shadowcrawl-mcp${{ matrix.exe_ext }}"

          # Include metadata files once.
          cp LICENSE "$dist/LICENSE"
          cp README.md "$dist/README.md"
          cp server.json "$dist/server.json"
          echo "$version" > "$dist/VERSION"

      - name: Build (release, non_robot_search)
        if: matrix.build_non_robot
        shell: bash
        env:
          OPENSSL_STATIC: "1"
          OPENSSL_VENDOR: "1"
        run: |
          set -euo pipefail
          cd mcp-server
          if [[ "${{ matrix.use_zig }}" == "true" ]]; then
            cargo zigbuild --release --locked --target "${{ matrix.target }}" --features non_robot_search --bin shadowcrawl --bin shadowcrawl-mcp
          else
            cargo build --release --locked --target "${{ matrix.target }}" --features non_robot_search --bin shadowcrawl --bin shadowcrawl-mcp
          fi

      - name: Stage artifacts (non_robot_search)
        if: matrix.build_non_robot
        shell: bash
        run: |
          set -euo pipefail
          dist="dist/${{ matrix.platform }}"
          base="mcp-server/target/${{ matrix.target }}/release"

          cp "$base/shadowcrawl${{ matrix.exe_ext }}" "$dist/shadowcrawl-non_robot_search${{ matrix.exe_ext }}"
          cp "$base/shadowcrawl-mcp${{ matrix.exe_ext }}" "$dist/shadowcrawl-mcp-non_robot_search${{ matrix.exe_ext }}"

      - name: Archive (tar.gz)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          set -euo pipefail
          version="${{ needs['check-trigger'].outputs.version }}"
          cd "dist/${{ matrix.platform }}"
          tar -czf "../shadowcrawl-${version}-${{ matrix.platform }}.tar.gz" .

      - name: Archive (zip)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          $version = "${{ needs['check-trigger'].outputs.version }}"
          $src = "dist/${{ matrix.platform }}"
          $dst = "dist/shadowcrawl-$version-${{ matrix.platform }}.zip"
          if (Test-Path $dst) { Remove-Item -Force $dst }
          Compress-Archive -Path "$src/*" -DestinationPath $dst

      - name: Upload build artifact (CI)
        uses: actions/upload-artifact@v4
        with:
          name: shadowcrawl-${{ matrix.platform }}
          path: |
            dist/shadowcrawl-*.${{ matrix.archive }}
          if-no-files-found: error

      - name: Attach assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs['check-trigger'].outputs.tag }}
          files: |
            dist/shadowcrawl-*-${{ matrix.platform }}.${{ matrix.archive }}
          generate_release_notes: false
