name: Publish to Official MCP Registry

on:
  push:
    branches:
      - main
      - master

jobs:
  check-trigger:
    name: Check [build] trigger
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if commit message contains [build]
        id: check
        shell: bash
        run: |
          set -euo pipefail
          msg="$(git log -1 --pretty=%B | tr -d '\r')"
          if echo "$msg" | grep -q "\[build\]"; then
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            echo "✅ Publish triggered: commit contains [build]" >&2
          else
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "⏭️  Skipping: commit does not contain [build]" >&2
          fi

  publish:
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_publish == 'true'
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for GitHub Release to exist
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          version="$(
            python3 - <<'PY'
import pathlib
import sys

try:
    import tomllib
except Exception as e:
    print('tomllib not available:', e, file=sys.stderr)
    sys.exit(1)

obj = tomllib.loads(pathlib.Path('mcp-server/Cargo.toml').read_text(encoding='utf-8'))
v = obj.get('package', {}).get('version', '')
if not v:
    print('Missing [package].version', file=sys.stderr)
    sys.exit(1)
print(v)
PY
          )"
          tag="v${version}"

          repo="${GITHUB_REPOSITORY}"
          url="https://api.github.com/repos/${repo}/releases/tags/${tag}"
          echo "Waiting for release tag ${tag} (${url})" >&2

          # Poll up to ~5 minutes.
          for i in $(seq 1 30); do
            code=$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$url" || true)

            if [[ "$code" == "200" ]]; then
              echo "✅ Release exists for ${tag}" >&2
              exit 0
            fi

            echo "... not ready yet (HTTP $code), retrying (${i}/30)" >&2
            sleep 10
          done

          echo "❌ Timed out waiting for GitHub Release ${tag}." >&2
          exit 1

      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher
          chmod +x ./mcp-publisher

      - name: Validate server.json
        run: ./mcp-publisher validate server.json

      - name: Login with GitHub OIDC
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish server.json
