services:
  redis:
    image: redis:alpine
    container_name: searxng-redis
    restart: unless-stopped
    networks:
      - searxng-net

  searxng:
    image: searxng/searxng:latest
    container_name: searxng-fork
    environment:
      - SEARXNG_SETTINGS_PATH=/etc/searxng/settings.yml
      - TRUSTED_PROXIES=127.0.0.1,172.16.0.0/12 
    volumes:
      - ./searxng:/etc/searxng:rw 
    depends_on:
      - redis
    networks:
      - searxng-net
    ports:
      - "8890:8080"

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant-fork
    ports:
      - "6343:6333"  # HTTP API
      - "6344:6334"  # gRPC API (optional)
    volumes:
      - qdrant_storage_fork:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped

  browserless:
    image: ghcr.io/browserless/chromium:latest 
    container_name: browserless-chromium
    ports:
      - "3010:3000"
    environment:
      - MAX_CONCURRENT_SESSIONS=10
      - TOKEN=mcp_stealth_session
      - PREBOOT_CHROME=true
      - DEFAULT_STEALTH=true
      - DEFAULT_BLOCK_ADS=true
    restart: unless-stopped
    mem_limit: 2g
    shm_size: 2gb
  search-scrape:
    build:
      context: .
      dockerfile: Dockerfile
    image: search-scrape-mcp:latest
    container_name: search-scrape-mcp
    ports:
      - "5001:5000"
    environment:
      - SEARXNG_URL=http://searxng:8080
      - QDRANT_URL=http://qdrant:6334
      - BROWSERLESS_URL=http://browserless:3000
      - BROWSERLESS_TOKEN=mcp_stealth_session
      - SEARXNG_CLIENT_IP=127.0.0.1
      - FASTEMBED_CACHE_DIR=/home/appuser/.cache/fastembed
      - HF_HOME=/home/appuser/.cache/huggingface
      - RUST_LOG=info
      - HTTP_TIMEOUT_SECS=30
      - HTTP_CONNECT_TIMEOUT_SECS=10
      - OUTBOUND_LIMIT=32
      - SCRAPE_DELAY_PRESET=polite
      - SCRAPE_DELAY_MIN_MS=500
      - SCRAPE_DELAY_MAX_MS=1500
      - MAX_CONTENT_CHARS=10000
      - MAX_LINKS=100
      - IP_LIST_PATH=/home/appuser/ip.txt
      - IP_LIST_DEFAULT_SCHEME=auto
      - PROXY_SOURCE_PATH=/home/appuser/proxy_source.json
    volumes:
      - fastembed_cache:/home/appuser/.cache/fastembed
      - huggingface_cache:/home/appuser/.cache/huggingface
      - ${IP_LIST_HOST_PATH:-./ip.txt}:/home/appuser/ip.txt:rw
      - ${PROXY_SOURCE_HOST_PATH:-./proxy_source.json}:/home/appuser/proxy_source.json:rw
    depends_on:
      - searxng
      - qdrant
      - browserless
    restart: unless-stopped
    networks:
      - default
      - searxng-net
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

networks:
  searxng-net:
    driver: bridge
    
volumes:
  qdrant_storage_fork:
    driver: local
  fastembed_cache:
    driver: local
  huggingface_cache:
    driver: local

  # Note: MCP server runs natively for better performance and compatibility
  # To run the MCP server natively:
  # 1. Build: cargo build --release
  # 2. HTTP server: SEARXNG_URL=http://localhost:8888 ./target/release/search-scrape
  # 3. MCP stdio server (with history): 
  #    SEARXNG_URL=http://localhost:8888 QDRANT_URL=http://localhost:6333 ./target/release/search-scrape-mcp
  # 4. MCP stdio server (without history):
  #    SEARXNG_URL=http://localhost:8888 ./target/release/search-scrape-mcp