services:
  shadowcrawl:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        CARGO_FEATURES: ${SHADOWCRAWL_CARGO_FEATURES:-}
    image: shadowcrawl-mcp:latest
    container_name: shadowcrawl-mcp
    ports:
      - "5001:5000"
    environment:
      - LANCEDB_URI=/home/appuser/lancedb
      - CHROME_EXECUTABLE=/usr/bin/chromium
      - HF_HOME=/home/appuser/.cache/huggingface
      - RUST_LOG=info
      - HTTP_TIMEOUT_SECS=30
      - HTTP_CONNECT_TIMEOUT_SECS=10
      - OUTBOUND_LIMIT=32
      - SCRAPE_DELAY_PRESET=polite
      - SCRAPE_DELAY_MIN_MS=500
      - SCRAPE_DELAY_MAX_MS=1500
      - MAX_CONTENT_CHARS=10000
      - MAX_LINKS=100
      - IP_LIST_PATH=/home/appuser/ip.txt
      - IP_LIST_DEFAULT_SCHEME=auto
      - PROXY_SOURCE_PATH=/home/appuser/proxy_source.json
    volumes:
      - huggingface_cache:/home/appuser/.cache/huggingface
      - lancedb_data:/home/appuser/lancedb
      - ${IP_LIST_HOST_PATH:-./ip.txt}:/home/appuser/ip.txt:rw
      - ${PROXY_SOURCE_HOST_PATH:-./proxy_source.json}:/home/appuser/proxy_source.json:rw
    shm_size: 1gb
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

volumes:
  huggingface_cache:
    driver: local
  lancedb_data:
    driver: local

  # Note: MCP server runs natively for better performance and compatibility
  # To run the MCP server natively:
  # 1. Build: cargo build --release
  # 2. HTTP server: ./target/release/shadowcrawl
  # 3. MCP stdio server (with history):
  #    LANCEDB_URI=./lancedb ./target/release/shadowcrawl-mcp
  # 4. MCP stdio server (without history):
  #    ./target/release/shadowcrawl-mcp